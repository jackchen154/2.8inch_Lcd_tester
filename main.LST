C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "STC12C5A.h"
   2          #include "main.h"
   3          #include "lcd_window.h"
   4          #include "uart.h"
   5          #include <intrins.h>  
   6          #define uchar unsigned char  
   7          #define uint  unsigned int 
   8          #define S2RI 0X01
   9          #define S2TI 0X02
  10          
  11          uchar lcd_status=0;//LCD½çÃæÇÐ»»×´Ì¬
  12          
  13          uchar com2_data[5]={0};
  14          uchar b=0;
  15          uchar data_buf[100]={0},start_recive=0,start_fram=0,frame_len=0,data_len=0;
  16          uchar data_buf1[20]={0},start_recive1=0,start_fram1=0,frame_len1=0,data_len1=0;
  17          
  18          unsigned short real_data[50]={0};//Ö÷¿Ø°å½ÓÊÕ½âÎö´æ·ÅµØ
  19          unsigned short real_data1[1]={0};//LCDÄ£¿é½ÓÊÕ½âÎö´æ·Å»º´æ(Ö»½âÎöÒ»¸ö¼Ä´æÆ÷ÄÚÈÝ)
  20          
  21          void Delay1ms()   //@11.0592MHz
  22          {
  23   1        unsigned char i, j;
  24   1      
  25   1        _nop_();
  26   1        _nop_();
  27   1        _nop_();
  28   1        i = 11;
  29   1        j = 190;
  30   1        do
  31   1        {
  32   2          while (--j);
  33   2        } while (--i);
  34   1      }
  35          
  36          void delayms(unsigned int ms)
  37          {
  38   1        while(ms--)
  39   1        Delay1ms();
  40   1      }
  41          
  42          
  43          
  44          void reboot(void)
  45          {
  46   1        IAP_CONTR=0X60;//×Ô¶¯ÖØÆôÏµÍ³
  47   1      }
  48          
  49          unsigned short get_crc1(uchar *ptr,uchar len)
  50          {
  51   1        uchar i;
  52   1        unsigned short crc=0xFFFF;
  53   1        if(len==0) len=1;
  54   1        while(len--)
  55   1        {
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 2   

  56   2          crc ^=*ptr;
  57   2          for(i=0;i<8;i++)
  58   2          {
  59   3            if(crc&1)
  60   3            {
  61   4              crc>>=1;
  62   4              crc ^= 0XA001; 
  63   4            }
  64   3            else crc>>=1;
  65   3          }
  66   2          ptr++;
  67   2        }
  68   1        return(crc);
  69   1      }
  70          
  71          unsigned short get_crc(uchar *ptr,uchar len)
  72          {
  73   1        uchar i;
  74   1        unsigned short crc=0xFFFF;
  75   1        if(len==0) len=1;
  76   1        while(len--)
  77   1        {
  78   2          crc ^=*ptr;
  79   2          for(i=0;i<8;i++)
  80   2          {
  81   3            if(crc&1)
  82   3            {
  83   4              crc>>=1;
  84   4              crc ^= 0XA001; 
  85   4            }
  86   3            else crc>>=1;
  87   3          }
  88   2          ptr++;
  89   2        }
  90   1        return(crc);
  91   1      }  
  92          
  93          unsigned short get_crc2(uchar *ptr,uchar len)
  94          {
  95   1        uchar i;
  96   1        unsigned short crc=0xFFFF;
  97   1        if(len==0) len=1;
  98   1        while(len--)
  99   1        {
 100   2          crc ^=*ptr;
 101   2          for(i=0;i<8;i++)
 102   2          {
 103   3            if(crc&1)
 104   3            {
 105   4              crc>>=1;
 106   4              crc ^= 0XA001; 
 107   4            }
 108   3            else crc>>=1;
 109   3          }
 110   2          ptr++;
 111   2        }
 112   1        return(crc);
 113   1      }
 114          
 115          unsigned short get_crc3(uchar *ptr,uchar len)
 116          {
 117   1        uchar i;
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 3   

 118   1        unsigned short crc=0xFFFF;
 119   1        if(len==0) len=1;
 120   1        while(len--)
 121   1        {
 122   2          crc ^=*ptr;
 123   2          for(i=0;i<8;i++)
 124   2          {
 125   3            if(crc&1)
 126   3            {
 127   4              crc>>=1;
 128   4              crc ^= 0XA001; 
 129   4            }
 130   3            else crc>>=1;
 131   3          }
 132   2          ptr++;
 133   2        }
 134   1        return(crc);
 135   1      } 
 136          
 137          void send_data(uchar device_n,uchar reg_n,uchar reg_mun)
 138          {
 139   1          unsigned short crc;
 140   1          uchar i=0;
 141   1          uchar read_buf[11]={0xaa,0x55,0xcc};
 142   1          read_buf[3]=device_n;
 143   1          read_buf[4]=0x03;
 144   1          read_buf[5]=0x00;
 145   1          read_buf[6]=reg_n;
 146   1          read_buf[7]=0x00;
 147   1          read_buf[8]=reg_mun;
 148   1          crc=get_crc1(&read_buf[3],6);
 149   1          read_buf[9]=crc&0xff;
 150   1          read_buf[10]=(crc>>8)&0xff;
 151   1          UART1_Send(read_buf,11);
 152   1        
 153   1      }      
 154          
 155          //(fd0,05,05,20,180)
 156          void motor_contrl_send(uchar device_n,uchar ctrl_mode,uchar speed,unsigned int weizhi)//¶æ»ú¿ØÖÆ
 157          {
 158   1            unsigned int crc;
 159   1            uchar read_buf[30]={0xaa,0x55,0xcc};
 160   1          read_buf[3]=device_n;
 161   1          read_buf[4]=0x10;
 162   1      
 163   1          read_buf[5]=0x00;
 164   1          read_buf[6]=0x00;
 165   1      
 166   1          read_buf[7]=0x00;
 167   1          read_buf[8]=0x07;
 168   1      
 169   1            read_buf[9]=0x0e;
 170   1      
 171   1            read_buf[10]=0x00;
 172   1            read_buf[11]=ctrl_mode;
 173   1      
 174   1            read_buf[12]=0x00;
 175   1            read_buf[13]=speed;
 176   1      
 177   1            read_buf[14]=weizhi>>8;
 178   1            read_buf[15]=weizhi&0x00ff;
 179   1      
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 4   

 180   1            read_buf[16]=0x12;
 181   1            read_buf[17]=0x0c;
 182   1      
 183   1            read_buf[18]=0x00;
 184   1            read_buf[19]=0x46;
 185   1      
 186   1            read_buf[20]=0x00;
 187   1            read_buf[21]=0x07;
 188   1      
 189   1            read_buf[22]=0x00;
 190   1            read_buf[23]=0x00;
 191   1      
 192   1          crc=get_crc2(&read_buf[3],21);
 193   1          read_buf[24]=crc&0xff;
 194   1          read_buf[25]=(crc>>8)&0xff;
 195   1      
 196   1          UART1_Send(read_buf,26);
 197   1      
 198   1        
 199   1      }
 200          
 201          void motor_contrl_send1(uchar reg_addr ,uchar ctrl_mode,uchar speed,uchar weizhi)//¶æ»ú¿ØÖÆ
 202          {
 203   1            unsigned int crc;
 204   1            uchar read_buf[18]={0xaa,0x55,0xcc};
 205   1          read_buf[3]=0x82;
 206   1          read_buf[4]=0x10;
 207   1      
 208   1          read_buf[5]=0x00;
 209   1          read_buf[6]=reg_addr;
 210   1      
 211   1          read_buf[7]=0x00;
 212   1          read_buf[8]=0x03;
 213   1      
 214   1            read_buf[9]=0x06;
 215   1      
 216   1            read_buf[10]=0x00;
 217   1            read_buf[11]=ctrl_mode;
 218   1      
 219   1            read_buf[12]=0x00;
 220   1            read_buf[13]=speed;
 221   1      
 222   1            read_buf[14]=0x00;
 223   1            read_buf[15]=weizhi;
 224   1      
 225   1            read_buf[16]=0x00;
 226   1            read_buf[17]=0x00;
 227   1      
 228   1      
 229   1          crc=get_crc2(&read_buf[3],13);
 230   1          read_buf[16]=crc&0xff;
 231   1          read_buf[17]=(crc>>8)&0xff;
 232   1      
 233   1          UART1_Send(read_buf,18);
 234   1      
 235   1        
 236   1      }
 237          
 238          //ÏÞÎ»Öµ·¢ËÍ
 239          void limit_value_contrl_send(uchar device_n ,uchar limit_up_location,uchar limit_down_location)
 240          {
 241   1          unsigned int crc;
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 5   

 242   1          uchar read_buf[30]={0xaa,0x55,0xcc};
 243   1          read_buf[3]=device_n;
 244   1          read_buf[4]=0x10;
 245   1      
 246   1          read_buf[5]=0x00;
 247   1          read_buf[6]=0x0b;
 248   1      
 249   1          read_buf[7]=0x00;
 250   1          read_buf[8]=0x02;
 251   1      
 252   1            read_buf[9]=0x04;
 253   1      
 254   1            read_buf[10]=0x00;
 255   1            read_buf[11]=limit_up_location;
 256   1      
 257   1            read_buf[12]=0x00;
 258   1            read_buf[13]=limit_down_location;
 259   1          
 260   1          crc=get_crc2(&read_buf[3],11);
 261   1          read_buf[14]=crc&0xff;
 262   1          read_buf[15]=(crc>>8)&0xff;
 263   1      
 264   1          UART1_Send(read_buf,16);
 265   1        
 266   1      }
 267          
 268          //ÏÞÖÆµçÁ÷·¢ËÍ
 269          void limit_current_contrl_send(uchar device_n ,uchar limit_current)
 270          {
 271   1          unsigned int crc;
 272   1          uchar read_buf[30]={0xaa,0x55,0xcc};
 273   1          read_buf[3]=device_n;
 274   1          read_buf[4]=0x10;
 275   1      
 276   1          read_buf[5]=0x00;
 277   1          read_buf[6]=0x07;
 278   1      
 279   1          read_buf[7]=0x00;
 280   1          read_buf[8]=0x01;
 281   1      
 282   1            read_buf[9]=0x02;
 283   1      
 284   1            read_buf[10]=0x00;
 285   1            read_buf[11]=limit_current;
 286   1      
 287   1          
 288   1          crc=get_crc2(&read_buf[3],9);
 289   1          read_buf[12]=crc&0xff;
 290   1          read_buf[13]=(crc>>8)&0xff;
 291   1      
 292   1          UART1_Send(read_buf,14);
 293   1        
 294   1      }
 295          
 296          void led_contrl_send(uchar device_n,uchar led1_cycle,uchar led2_cycle,uchar liangdu)//LED¿ØÖÆ
 297          {
 298   1            unsigned int crc;
 299   1            uchar read_buf[17]={0xaa,0x55,0xcc};
 300   1          read_buf[3]=device_n;
 301   1          read_buf[4]=0x10;
 302   1      
 303   1          read_buf[5]=0x00;
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 6   

 304   1          read_buf[6]=0x00;
 305   1      
 306   1          read_buf[7]=0x00;
 307   1          read_buf[8]=0x03;
 308   1      
 309   1            read_buf[9]=0x06;
 310   1      
 311   1            read_buf[10]=0x00;
 312   1            read_buf[11]=led1_cycle;
 313   1      
 314   1            read_buf[12]=0x00;
 315   1            read_buf[13]=led2_cycle;
 316   1      
 317   1            read_buf[14]=0x00;
 318   1            read_buf[15]=liangdu;
 319   1      
 320   1          crc=get_crc2(&read_buf[3],13);
 321   1          read_buf[16]=crc&0xff;
 322   1          read_buf[17]=(crc>>8)&0xff;
 323   1          UART1_Send(read_buf,18);
 324   1        
 325   1      }
 326          
 327          void led_contrl_send1(uchar power,uchar red,uchar green,uchar blue)//LED¿ØÖÆ
 328          {
 329   1            unsigned int crc;
 330   1            uchar read_buf[20]={0xaa,0x55,0xcc};
 331   1          read_buf[3]=0x82;
 332   1          read_buf[4]=0x10;
 333   1      
 334   1          read_buf[5]=0x00;
 335   1          read_buf[6]=0x00;
 336   1      
 337   1          read_buf[7]=0x00;
 338   1          read_buf[8]=0x04;
 339   1      
 340   1            read_buf[9]=0x08;
 341   1      
 342   1            read_buf[10]=0x00;
 343   1            read_buf[11]=power;
 344   1      
 345   1            read_buf[12]=0x00;
 346   1            read_buf[13]=red;
 347   1      
 348   1            read_buf[14]=0x00;
 349   1            read_buf[15]=green;
 350   1            
 351   1            read_buf[16]=0x00;
 352   1            read_buf[17]=blue;      
 353   1      
 354   1            read_buf[18]=0x00;
 355   1            read_buf[19]=0x00;
 356   1          crc=get_crc2(&read_buf[3],15);
 357   1          read_buf[18]=crc&0xff;
 358   1          read_buf[19]=(crc>>8)&0xff;
 359   1          UART1_Send(read_buf,20);
 360   1        
 361   1      }
 362          
 363          void main_board_contrl_send(uchar run_mode,uchar left_speed,uchar right_speed)//Ö÷¿Ø°å¶àÐ´
 364          {
 365   1            unsigned int crc;
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 7   

 366   1            uchar read_buf[20]={0xaa,0x55,0xcc};
 367   1          read_buf[3]=0x81;
 368   1          read_buf[4]=0x10;
 369   1      
 370   1          read_buf[5]=0x00;
 371   1          read_buf[6]=0x00;
 372   1      
 373   1          read_buf[7]=0x00;
 374   1          read_buf[8]=0x04;
 375   1      
 376   1            read_buf[9]=0x08;
 377   1      
 378   1            read_buf[10]=0x00;
 379   1            read_buf[11]=run_mode;
 380   1      
 381   1            read_buf[12]=left_speed;
 382   1            read_buf[13]=right_speed;
 383   1      
 384   1            read_buf[14]=0x05;
 385   1            read_buf[15]=0x0a;
 386   1      
 387   1            read_buf[16]=0x05;
 388   1            read_buf[17]=0x0a;
 389   1            
 390   1            read_buf[18]=0x00;
 391   1            read_buf[19]=0x00;
 392   1            
 393   1          crc=get_crc2(&read_buf[3],15);
 394   1          read_buf[18]=crc&0xff;
 395   1          read_buf[19]=(crc>>8)&0xff;
 396   1          UART1_Send(read_buf,20);
 397   1        
 398   1      }
 399          
 400          void main_board_contrl_send1(uchar run_mode,uchar left_speed,uchar right_speed)//Ö÷¿Ø°å¶àÐ´
 401          {
 402   1          unsigned int crc;
 403   1          uchar read_buf[20]={0xaa,0x55,0xcc};
 404   1          read_buf[3]=0x81;
 405   1          read_buf[4]=0x10;
 406   1      
 407   1          read_buf[5]=0x00;
 408   1          read_buf[6]=0x00;
 409   1      
 410   1          read_buf[7]=0x00;
 411   1          read_buf[8]=0x04;
 412   1      
 413   1            read_buf[9]=0x08;
 414   1      
 415   1            read_buf[10]=0x00;//reg:0
 416   1            read_buf[11]=run_mode;
 417   1      
 418   1            read_buf[12]=0x00;//reg:1
 419   1            read_buf[13]=left_speed;
 420   1            
 421   1            read_buf[14]=0x00;//reg:2   
 422   1            read_buf[15]=right_speed;
 423   1      
 424   1            read_buf[16]=0x05;//reg:3
 425   1            read_buf[17]=0x0a;
 426   1      
 427   1            read_buf[18]=0x05;//reg:4
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 8   

 428   1            read_buf[19]=0x0a;
 429   1            
 430   1            read_buf[20]=0x00;
 431   1            read_buf[21]=0x00;
 432   1            
 433   1          crc=get_crc2(&read_buf[3],17);
 434   1          read_buf[20]=crc&0xff;
 435   1          read_buf[21]=(crc>>8)&0xff;
 436   1          UART1_Send(read_buf,22);
 437   1        
 438   1      }
 439          
 440          void Main(void)  
 441          {  
 442   1        UART1_Init();
 443   1        UART2_Init();
 444   1      
 445   1        Lcd_control("page index"); 
 446   1        //Lcd_control("page ultrasonic");   
 447   1        while(1)
 448   1        { 
 449   2                if(lcd_status==Sensor_window)
 450   2                {               
 451   3                    Lcd_control("page ultrasonic");
 452   3                  
 453   3                    TH1 = 0xFD;   
 454   3                    TL1 = TH1;  //115200            
 455   3                    while (1) 
 456   3                    { 
 457   4                      if(ultrasonic_window(real_data)<0) break;
 458   4                      delayms(50);
 459   4                    }
 460   3                 }
 461   2                if(lcd_status==Sensor_window1)
 462   2                {               
 463   3                    Lcd_control("page ultrasonic1");
 464   3                  
 465   3                    TH1 = 0xFD;   
 466   3                    TL1 = TH1;  //115200            
 467   3                    while (1) 
 468   3                    { 
 469   4                      if(ultrasonic_window1(real_data)<0) break;
 470   4                      delayms(50);
 471   4                    }
 472   3                 }          
 473   2                 
 474   2                 
 475   2                if(lcd_status==Control_window)//»úÆ÷ÈË¿ØÖÆ
 476   2                {               
 477   3                    Lcd_control("page robot control");
 478   3                  
 479   3                    TH1 = 0xFD;   
 480   3                    TL1 = TH1;  //115200            
 481   3                    while (1) 
 482   3                    { 
 483   4                      if(robot_ctrl_window(real_data)<0) break;
 484   4                      delayms(250);
 485   4                    }
 486   3                 }
 487   2                if(lcd_status==Control_window1)//»úÆ÷ÈË¿ØÖÆ
 488   2                {               
 489   3                    Lcd_control("page robot control1");
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 9   

 490   3                  
 491   3                    TH1 = 0xFD;   
 492   3                    TL1 = TH1;  //115200            
 493   3                    while (1) 
 494   3                    { 
 495   4                      if(robot_ctrl_window1(real_data)<0) break;
 496   4                      delayms(250);
 497   4                    }
 498   3                 }          
 499   2                 
 500   2                 if(lcd_status==versions_window)
 501   2                 {   
 502   3      
 503   3                    Lcd_control("page version");     
 504   3                    while (1) 
 505   3                    { 
 506   4                      if(version_window(real_data)<0) break;
 507   4                      delayms(250);
 508   4                    }
 509   3                 }
 510   2      
 511   2                 if(lcd_status==versions_window1)
 512   2                 {   
 513   3      
 514   3                    Lcd_control("page version1");     
 515   3                    while (1) 
 516   3                    { 
 517   4                      if(version_window1(real_data)<0) break;
 518   4                      delayms(250);
 519   4                    }
 520   3                 }  
 521   2      
 522   2                 
 523   2                 if(lcd_status==Headctr_window)
 524   2                 {   
 525   3                    Lcd_control("page head contrl");
 526   3                    TH1 = 0xf7; 
 527   3                    TL1 = TH1;  //38400²¨ÌØÂÊ              
 528   3                    motor_contrl_send(0x01,0x00,0,0);//³õÊ¼»¯¶æ»ú
 529   3                    delayms(30);
 530   3                    motor_contrl_send(0x06,0x00,0,0);//³õÊ¼»¯¶æ»ú
 531   3                    delayms(30);  
 532   3                    motor_contrl_send(0x07,0x00,0,0);//³õÊ¼»¯¶æ»ú     
 533   3                    while (1) //Ñ­»·¶ÁÈ¡Êý¾Ý
 534   3                    {         
 535   4                      if(motor_ctrl_window(real_data)<0) break;
 536   4                      delayms(10);
 537   4                    }
 538   3                  } 
 539   2      
 540   2                 if(lcd_status==Headctr_window1)
 541   2                 {   
 542   3                    Lcd_control("page head contrl1");
 543   3                    TH1 = 0xFD;   
 544   3                    TL1 = TH1;  //115200           
 545   3                    motor_contrl_send1(0x05,0x00,0,0);//³õÊ¼»¯¶æ»ú
 546   3                    delayms(30);
 547   3                    motor_contrl_send1(0x16,0x00,0,0);//³õÊ¼»¯¶æ»ú
 548   3                    delayms(30);  
 549   3                    motor_contrl_send1(0x23,0x00,0,0);//³õÊ¼»¯¶æ»ú     
 550   3                    while (1) //Ñ­»·¶ÁÈ¡Êý¾Ý
 551   3                    {         
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 10  

 552   4                      if(motor_ctrl_window1()<0) break;
 553   4                      delayms(10);
 554   4                    }
 555   3                  } 
 556   2                  
 557   2                 if(lcd_status==duojixianzhi_window)
 558   2                 {   
 559   3                    Lcd_control("page duojixianzhi");
 560   3                    TH1 = 0xf7; 
 561   3                    TL1 = TH1;  //38400²¨ÌØÂÊ                  
 562   3                    while (1) //Ñ­»·¶ÁÈ¡Êý¾Ý
 563   3                    {         
 564   4                      if(Duojixianzhi_window(real_data)<0) break;
 565   4                    }
 566   3                  }          
 567   2              delayms(1);
 568   2              
 569   2         }//end while(1)
 570   1      }
 571            
 572          void zhukongjieshou(void) interrupt 4  
 573          {
 574   1        uchar i,j;
 575   1        unsigned short crc_result,ck_crc;            
 576   1        if(RI == 1)   //µ±Ó²¼þ½ÓÊÕµ½Ò»¸öÊý¾ÝÊ±£¬RI»áÖÃÎ»  
 577   1        {
 578   2          RI = 0; 
 579   2          data_buf[data_len]=SBUF;
 580   2          if(start_recive==0)
 581   2          {
 582   3            if(data_len==0&&data_buf[data_len]==0xaa)
 583   3            {  
 584   4              data_len=1; 
 585   4            }      
 586   3          else if(data_len==1&&data_buf[data_len]==0xaa)//ÈçÏÂ´Î´«À´µÄ»¹ÊÇÖ¡Í·ÔÙ´ÎÒÔaa¿ªÊ¼ÅÐ¶ÏÖ¡
 587   3            {  
 588   4             data_len=1;  
 589   4            } 
 590   3            else if(data_len==1&&data_buf[data_len]==0x55)
 591   3            {
 592   4              data_len=2;  
 593   4            }    
 594   3            else if(data_len==2&&data_buf[data_len]==0xcc)
 595   3            {  
 596   4             start_recive=1;
 597   4            } 
 598   3            else 
 599   3            {
 600   4             data_len=0;
 601   4            }
 602   3          }    
 603   2          if(start_recive==1)
 604   2          {
 605   3            if(start_fram==1)//½ÓÊÕ³¤¶ÈÏÞÖÆ
 606   3            {
 607   4              if(frame_len>=70)
 608   4              {
 609   5                 start_recive=0;           
 610   5                 start_fram=0;
 611   5             data_len=0;
 612   5             frame_len=0;
 613   5                 return;
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 11  

 614   5              }
 615   4              frame_len--;
 616   4              if(frame_len==0)
 617   4              {
 618   5                 crc_result = get_crc(&data_buf[3],data_buf[5]+3);//Êý¾ÝÖ¡¼ÆËãCRC
 619   5                 ck_crc = data_buf[ (data_buf[5]+7)]<<8 | data_buf[ (data_buf[5]+6) ];//µÍ¸ß×Ö½ÚCRC×ª»»ÎªÕûÊý
 620   5               if(crc_result==ck_crc)//CRCÐ£Ñé±È¶Ô
 621   5               {  
 622   6                 for(i=0;i<(data_buf[5]/2);i++)//¼ÆËãÊý¾Ý¶Ô¸öÊý
 623   6                 {
 624   7                   real_data[i]=data_buf[6+j]<<8| data_buf[7+j];//ÓÐÐ§Êý¾ÝºÏÎª2¸ö×Ö½ÚµÄÊý¾Ý£¨Ò»¸ö¼Ä´æÆ÷µÄÊý¾ÝÖµÎª
             -2¸ö×Ö½Ú£© 
 625   7                   j=j+2;
 626   7                 }           
 627   6               }
 628   5               if(real_data[0]==0x1122 && real_data[1]==0x3344)
 629   5               reboot();
 630   5               start_recive=0;
 631   5               start_fram=0;
 632   5               data_len=0;
 633   5               frame_len=0;
 634   5               j=0; i=0;
 635   5               return;
 636   5              }
 637   4            }        
 638   3            if(data_len==5)
 639   3            {
 640   4              start_fram=1;
 641   4              frame_len=data_buf[5]+2;
 642   4            }
 643   3            data_len++;
 644   3          }
 645   2        }
 646   1      }
 647          
 648          void lcdjieshou(void) interrupt 8 using 1//½ÓÊÕ×Ö·û¼°´¦Àí
 649          { 
 650   1      
 651   1       uchar i,j;
 652   1       unsigned short crc_result,ck_crc;
 653   1      
 654   1      if(S2CON&S2RI)//ÓÐÊý¾Ý´«À´£¬Ó²¼þÖÃÎ»S2RI
 655   1      {
 656   2       S2CON&=~S2RI;  //Çå³ýÖÃÎ»£¬ÒÔ±ãÏÂÒ»Êý¾Ý´«À´     
 657   2         data_buf1[data_len1]=S2BUF; 
 658   2           if(start_recive1==0)
 659   2           {
 660   3             if(data_len1==0&&data_buf1[data_len1]==0xaa)
 661   3             {  
 662   4               data_len1=1;         
 663   4             }      
 664   3           else if(data_len1==1&&data_buf1[data_len1]==0xaa)//ÈçÏÂ´Î´«À´µÄ»¹ÊÇÖ¡Í·ÔÙ´ÎÒÔaa¿ªÊ¼ÅÐ¶ÏÖ¡
 665   3             {  
 666   4              data_len1=1;  
 667   4             } 
 668   3             else if(data_len1==1&&data_buf1[data_len1]==0x55)
 669   3             {
 670   4               data_len1=2;           
 671   4             }    
 672   3             else if(data_len1==2&&data_buf1[data_len1]==0xcc)
 673   3             {  
 674   4              start_recive1=1;        
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 12  

 675   4             }  
 676   3             else 
 677   3             {
 678   4              data_len1=0;
 679   4             }
 680   3           }    
 681   2           if(start_recive1==1)
 682   2           {
 683   3              
 684   3             if(start_fram1==1)//½ÓÊÕ³¤¶ÈÏÞÖÆ
 685   3             {
 686   4              if(frame_len1>=70)
 687   4              {
 688   5                 start_recive1=0;           
 689   5                 start_fram1=0;
 690   5                 data_len1=0;
 691   5                 frame_len1=0;
 692   5              }
 693   4              frame_len1--;
 694   4              if(frame_len1==0)
 695   4              {
 696   5                 crc_result = get_crc3(&data_buf1[3],data_buf1[5]+3);//Êý¾ÝÖ¡¼ÆËãCRC
 697   5                 ck_crc = data_buf1[ (data_buf1[5]+7)]<<8 | data_buf1[ (data_buf1[5]+6) ];//µÍ¸ß×Ö½ÚCRC×ª»»ÎªÕû”
             -¼
 698   5               if(crc_result==ck_crc)//CRCÐ£Ñé±È¶Ô
 699   5               {  
 700   6                 for(i=0;i<(data_buf1[5]/2);i++)//¼ÆËãÊý¾Ý¶Ô¸ö”¼
 701   6                 {
 702   7                   real_data1[i]=data_buf1[6+j]<<8| data_buf1[7+j];//ÓÐÐ§Êý¾ÝºÏÎª2¸ö×Ö½ÚµÄÊý¾Ý£¨Ò»¸ö¼Ä´æÆ÷µÄÊý¾ÝÖ
             -µÎª2¸ö×Ö½Ú£© 
 703   7                   j=j+2;
 704   7                 }           
 705   6               }            
 706   5                 start_recive1=0;
 707   5                 start_fram1=0;
 708   5                 data_len1=0;
 709   5                 frame_len1=0;
 710   5                 j=0; i=0;
 711   5           
 712   5                 //Ò³Ãæ´°¿Ú²¿¼þ
 713   5                 if(real_data1[0]==0x0000)
 714   5                 {
 715   6                   lcd_status=Control_window;
 716   6                 }
 717   5                 if(real_data1[0]==0x0005)
 718   5                 {
 719   6                   lcd_status=Control_window1;
 720   6                 }  
 721   5      
 722   5                 
 723   5                 if(real_data1[0]==0x0001)
 724   5                 {
 725   6                   lcd_status=Sensor_window;
 726   6                 }
 727   5                 if(real_data1[0]==0x0006)
 728   5                 {
 729   6                   lcd_status=Sensor_window1;
 730   6                 }      
 731   5      
 732   5                 
 733   5                 if(real_data1[0]==0x0002)
 734   5                 {
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 13  

 735   6                   lcd_status=Headctr_window;
 736   6                 }
 737   5                 if(real_data1[0]==0x0007)
 738   5                 {
 739   6                   lcd_status=Headctr_window1;
 740   6                 }           
 741   5                 
 742   5                 if(real_data1[0]==0x0003)
 743   5                 {
 744   6                   lcd_status=versions_window;
 745   6                 }
 746   5                 if(real_data1[0]==0x0008)
 747   5                 {
 748   6                   lcd_status=versions_window1;
 749   6                 }           
 750   5                 
 751   5                 
 752   5                 if(real_data1[0]==0x0004)
 753   5                 {
 754   6                   ////printf("versions_window\n");
 755   6                   lcd_status=duojixianzhi_window;
 756   6                 }           
 757   5                 if(real_data1[0]==0x00bc)
 758   5                 {
 759   6                   lcd_status=Return_button;
 760   6                 }
 761   5                   if(real_data1[0]==0xbc01)
 762   5                 {
 763   6                   lcd_status=Return_button1;
 764   6                 }         
 765   5                 
 766   5                 //Í·²¿´°¿Ú²¿¼þ
 767   5                 if(real_data1[0]==0x0300)
 768   5                 {
 769   6                   ////printf("hbiaoding\n");
 770   6                   lcd_status=hbiaoding;
 771   6                 }
 772   5                 if(real_data1[0]==0x0301)
 773   5                 {
 774   6                   ////printf("hzuo\n");
 775   6                   lcd_status=hzuo;
 776   6                 } 
 777   5                 if(real_data1[0]==0x0302)
 778   5                 {
 779   6                   ////printf("hzhong\n");
 780   6                   lcd_status=hzhong;
 781   6                 } 
 782   5                 if(real_data1[0]==0x0303)
 783   5                 {
 784   6                   ////printf("hyou\n");
 785   6                   lcd_status=hyou;
 786   6                 }
 787   5      
 788   5                 //×óÊÖ´°¿Ú²¿¼þ
 789   5                 if(real_data1[0]==0x031a)
 790   5                 {
 791   6                   ////printf("jieshouzbiaoding\n");
 792   6                   lcd_status=zbiaoding;
 793   6                 }
 794   5                 if(real_data1[0]==0x0310)
 795   5                 {
 796   6                   ////printf("jieshouzzuo\n");
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 14  

 797   6                   lcd_status=zzuo;
 798   6                 } 
 799   5                 if(real_data1[0]==0x0312)
 800   5                 {
 801   6                   ////printf("jieshouzzhong\n");
 802   6                   lcd_status=zzhong;
 803   6                 } 
 804   5                 if(real_data1[0]==0x031b)
 805   5                 {
 806   6                   ////printf("jieshouzyou\n");
 807   6                   lcd_status=zyou;
 808   6                 }
 809   5      
 810   5                 //ÓÒÊÖ´°¿Ú²¿¼þ
 811   5                 if(real_data1[0]==0x0320)
 812   5                 {
 813   6                   ////printf("ybiaoding\n");
 814   6                   lcd_status=ybiaoding;
 815   6                 }
 816   5                 if(real_data1[0]==0x0321)
 817   5                 {
 818   6                   ////printf("yzuo\n");
 819   6                   lcd_status=yzuo;
 820   6                 } 
 821   5                 if(real_data1[0]==0x0322)
 822   5                 {
 823   6                   ////printf("yzhong\n");
 824   6                   lcd_status=yzhong;
 825   6                 } 
 826   5                 if(real_data1[0]==0x0323)
 827   5                 {
 828   6                   ////printf("yyou\n");
 829   6                   lcd_status=yyou;
 830   6                 }
 831   5      
 832   5                 //LEDµÆ°å¿ØÖÆ²¿¼þ 
 833   5                 if(real_data1[0]==0x03aa)
 834   5                 {
 835   6                   ////printf("zui0\n");
 836   6                   lcd_status=led00;
 837   6                 } 
 838   5                 if(real_data1[0]==0x03bb)
 839   5                 {
 840   6                   ////printf("zui1\n");
 841   6                   lcd_status=led01;
 842   6                 } 
 843   5                 if(real_data1[0]==0x03cc)
 844   5                 {
 845   6                   ////printf("yan0\n");
 846   6                   lcd_status=led10;
 847   6                 } 
 848   5                 if(real_data1[0]==0x03dd)
 849   5                 {
 850   6                   ////printf("yan1\n");
 851   6                   lcd_status=led11;
 852   6                 }
 853   5      
 854   5                 //Á¬Ðø¿ØÖÆ²¿¼þ 
 855   5                 if(real_data1[0]==0x0334)
 856   5                 {
 857   6                   ////printf("lianxu0\n");
 858   6                   lcd_status=alianxu0;
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 15  

 859   6                 } 
 860   5                 if(real_data1[0]==0x0335)
 861   5                 {
 862   6                   ////printf("lianxu1\n");
 863   6                   lcd_status=alianxu1;
 864   6                 }
 865   5                 //real_data1[0]=0x0000;
 866   5                 
 867   5                 //×Ô¶¯³äµç²¿¼þ
 868   5                 if(real_data1[0]==0xc100)//¹Ø±Õ³äµç
 869   5                 {
 870   6                   lcd_status=auto_charge_off;
 871   6                 } 
 872   5                 if(real_data1[0]==0xc101)//¿ªÆô³äµç
 873   5                 {
 874   6                   lcd_status=auto_charge_on;
 875   6                 }
 876   5                 
 877   5                 //»úÆ÷ÈË¿ØÖÆÐÐ×ß²¿·Ö
 878   5                  if(real_data1[0]==0xd1d1)//ÉÏ
 879   5                  { 
 880   6                   lcd_status=go_up;
 881   6                  } 
 882   5                 if(real_data1[0]==0xd2d2)//ÏÂ
 883   5                 {
 884   6                   lcd_status=go_down;
 885   6                 }
 886   5                  if(real_data1[0]==0xd3d3)//×ó
 887   5                 {
 888   6                   lcd_status=go_left;
 889   6                 } 
 890   5                 if(real_data1[0]==0xd4d4)//ÓÒ
 891   5                 {
 892   6                   lcd_status=go_right;
 893   6                 }
 894   5                 if(real_data1[0]==0xd0d0)//Í£
 895   5                 {
 896   6                   lcd_status=go_stop;
 897   6                 }
 898   5                 //ÏÞÎ»ÉèÖÃ¿Ø¼þ
 899   5                 if(real_data1[0]==0x0401)//Í£
 900   5                 {
 901   6                   lcd_status=set_limit_value;
 902   6                 }
 903   5                 return;
 904   5      
 905   5              }
 906   4            }        
 907   3            if(data_len1==5)
 908   3            {
 909   4              start_fram1=1;
 910   4              frame_len1=data_buf1[5]+2;
 911   4            }
 912   3            data_len1++;
 913   3          }
 914   2         
 915   2       }
 916   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3491    ----
C51 COMPILER V9.00   MAIN                                                                  05/07/2019 15:15:39 PAGE 16  

   CONSTANT SIZE    =    359    ----
   XDATA SIZE       =    237     244
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
