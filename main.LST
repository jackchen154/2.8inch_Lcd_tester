C51 COMPILER V9.00   MAIN                                                                  02/26/2018 19:43:36 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "STC12C5A.h"
   2          #include "main.h"
   3          #include "lcd_window.h"
   4          #include "uart.h"
   5          #include <intrins.h>  
   6          #define uchar unsigned char  
   7          #define uint  unsigned int 
   8          #define S2RI 0X01
   9          #define S2TI 0X02
  10          
  11          uchar lcd_status=0;//LCD½çÃæÇÐ»»×´Ì¬
  12          
  13          uchar com2_data[5]={0};
  14          uchar b=0;
  15          uchar data_buf[100]={0},start_recive=0,start_fram=0,frame_len=0,data_len=0;
  16          uchar data_buf1[20]={0},start_recive1=0,start_fram1=0,frame_len1=0,data_len1=0;
  17          
  18          unsigned short real_data[50]={0};
  19          unsigned short real_data1[1]={0};
  20          
  21          void Delay1ms()         //@11.0592MHz
  22          {
  23   1              unsigned char i, j;
  24   1      
  25   1              _nop_();
  26   1              _nop_();
  27   1              _nop_();
  28   1              i = 11;
  29   1              j = 190;
  30   1              do
  31   1              {
  32   2                      while (--j);
  33   2              } while (--i);
  34   1      }
  35          
  36          void delayms(uchar ms)
  37          {
  38   1        while(ms--)
  39   1        Delay1ms();
  40   1      }
  41          
  42          
  43          
  44          void reboot(void)
  45          {
  46   1              IAP_CONTR=0X60;//×Ô¶¯ÖØÆôÏµÍ³
  47   1      }
  48          unsigned short get_crc1(uchar *ptr,uchar len)
  49          {
  50   1        uchar i;
  51   1        unsigned short crc=0xFFFF;
  52   1        if(len==0) len=1;
  53   1        while(len--)
  54   1        {
  55   2          crc ^=*ptr;
C51 COMPILER V9.00   MAIN                                                                  02/26/2018 19:43:36 PAGE 2   

  56   2          for(i=0;i<8;i++)
  57   2          {
  58   3            if(crc&1)
  59   3            {
  60   4              crc>>=1;
  61   4              crc ^= 0XA001; 
  62   4            }
  63   3            else crc>>=1;
  64   3          }
  65   2          ptr++;
  66   2        }
  67   1        return(crc);
  68   1      }
  69          
  70          unsigned short get_crc(uchar *ptr,uchar len)
  71          {
  72   1        uchar i;
  73   1        unsigned short crc=0xFFFF;
  74   1        if(len==0) len=1;
  75   1        while(len--)
  76   1        {
  77   2          crc ^=*ptr;
  78   2          for(i=0;i<8;i++)
  79   2          {
  80   3            if(crc&1)
  81   3            {
  82   4              crc>>=1;
  83   4              crc ^= 0XA001; 
  84   4            }
  85   3            else crc>>=1;
  86   3          }
  87   2          ptr++;
  88   2        }
  89   1        return(crc);
  90   1      }  
  91          
  92          unsigned short get_crc3(uchar *ptr,uchar len)
  93          {
  94   1        uchar i;
  95   1        unsigned short crc=0xFFFF;
  96   1        if(len==0) len=1;
  97   1        while(len--)
  98   1        {
  99   2          crc ^=*ptr;
 100   2          for(i=0;i<8;i++)
 101   2          {
 102   3            if(crc&1)
 103   3            {
 104   4              crc>>=1;
 105   4              crc ^= 0XA001; 
 106   4            }
 107   3            else crc>>=1;
 108   3          }
 109   2          ptr++;
 110   2        }
 111   1        return(crc);
 112   1      } 
 113          
 114          void send_data(uchar device_n,uchar reg_n,uchar reg_mun)
 115          {
 116   1                unsigned short crc;
 117   1                uchar i=0;
C51 COMPILER V9.00   MAIN                                                                  02/26/2018 19:43:36 PAGE 3   

 118   1          uchar read_buf[11]={0xaa,0x55,0xcc};
 119   1                read_buf[3]=device_n;
 120   1                read_buf[4]=0x03;
 121   1                read_buf[5]=0x00;
 122   1                read_buf[6]=reg_n;
 123   1                read_buf[7]=0x00;
 124   1                read_buf[8]=reg_mun;
 125   1                crc=get_crc1(&read_buf[3],6);
 126   1                read_buf[9]=crc&0xff;
 127   1                read_buf[10]=(crc>>8)&0xff;
 128   1                UART1_Send(read_buf,11);
 129   1              
 130   1      }      
 131          
 132          
 133          void Main(void)  
 134          {  
 135   1        UART1_Init();
 136   1        UART2_Init();
 137   1      
 138   1        Lcd_control("page main");     
 139   1        while(1)
 140   1        { 
 141   2                if(lcd_status==Sensor_window)
 142   2                {   
 143   3                    Lcd_control("page ultrasonic");     
 144   3                    while (1) 
 145   3                                                      { 
 146   4                      send_data(0x81,0x80,27); 
 147   4                      if(ultrasonic_window(real_data)<0) break;
 148   4                      delayms(1000);
 149   4                    }
 150   3                 }
 151   2      
 152   2                 if(lcd_status==versions_window)
 153   2                 {   
 154   3                    TH1 = 0xf7;       //¶¨Ê±Æ÷³õÖµ¸ß8Î»ÉèÖÃ38400
 155   3                        TL1 = TH1;    //¶¨Ê±Æ÷³õÖµµÍ8Î»ÉèÖÃ
 156   3                                Lcd_control("page version");     
 157   3                    while (1) 
 158   3                    { 
 159   4                      if(version_window(real_data)<0) break;
 160   4                      delayms(1000);
 161   4                    }
 162   3                 } 
 163   2              delayms(100);
 164   2              
 165   2         }//end while(1)
 166   1      }
 167                  
 168          void zhukongjieshou(void)       interrupt 4  
 169          {
 170   1        uchar i,j;
 171   1        unsigned short crc_result,ck_crc;            
 172   1        if(RI == 1)   //µ±Ó²¼þ½ÓÊÕµ½Ò»¸öÊý¾ÝÊ±£¬RI»áÖÃÎ»      
 173   1        {
 174   2          RI = 0; 
 175   2          data_buf[data_len]=SBUF;
 176   2          if(start_recive==0)
 177   2          {
 178   3            if(data_len==0&&data_buf[data_len]==0xaa)
 179   3            {  
C51 COMPILER V9.00   MAIN                                                                  02/26/2018 19:43:36 PAGE 4   

 180   4              data_len=1; 
 181   4            }      
 182   3                else if(data_len==1&&data_buf[data_len]==0xaa)//ÈçÏÂ´Î´«À´µÄ»¹ÊÇÖ¡Í·ÔÙ´ÎÒÔaa¿ªÊ¼ÅÐ¶ÏÖ¡
 183   3            {  
 184   4             data_len=1;  
 185   4            } 
 186   3            else if(data_len==1&&data_buf[data_len]==0x55)
 187   3            {
 188   4              data_len=2;  
 189   4            }    
 190   3            else if(data_len==2&&data_buf[data_len]==0xcc)
 191   3            {  
 192   4             start_recive=1;
 193   4            } 
 194   3            else 
 195   3            {
 196   4             data_len=0;
 197   4            }
 198   3          }    
 199   2          if(start_recive==1)
 200   2          {
 201   3            if(start_fram==1)//½ÓÊÕ³¤¶ÈÏÞÖÆ
 202   3            {
 203   4              if(frame_len>=70)
 204   4              {
 205   5                 start_recive=0;           
 206   5                 start_fram=0;
 207   5                         data_len=0;
 208   5                         frame_len=0;
 209   5                 return;
 210   5              }
 211   4              frame_len--;
 212   4              if(frame_len==0)
 213   4              {
 214   5                 crc_result = get_crc(&data_buf[3],data_buf[5]+3);//Êý¾ÝÖ¡¼ÆËãCRC
 215   5                 ck_crc = data_buf[ (data_buf[5]+7)]<<8 | data_buf[ (data_buf[5]+6) ];//µÍ¸ß×Ö½ÚCRC×ª»»ÎªÕûÊý
 216   5                     if(crc_result==ck_crc)//CRCÐ£Ñé±È¶Ô
 217   5                     {  
 218   6                       for(i=0;i<(data_buf[5]/2);i++)//¼ÆËãÊý¾Ý¶Ô¸öÊý
 219   6                       {
 220   7                         real_data[i]=data_buf[6+j]<<8| data_buf[7+j];//ÓÐÐ§Êý¾ÝºÏÎª2¸ö×Ö½ÚµÄÊý¾Ý£¨Ò»¸ö¼Ä´æÆ÷µÄÊý¾ÝÖµÎª
             -2¸ö×Ö½Ú£© 
 221   7                         j=j+2;
 222   7                       }               
 223   6               }
 224   5                                       if(real_data[0]==0x1122 && real_data[1]==0x3344)
 225   5                                       reboot();
 226   5               start_recive=0;
 227   5               start_fram=0;
 228   5                           data_len=0;
 229   5                           frame_len=0;
 230   5                           j=0; i=0;
 231   5               return;
 232   5              }
 233   4            }        
 234   3            if(data_len==5)
 235   3            {
 236   4              start_fram=1;
 237   4              frame_len=data_buf[5]+2;
 238   4            }
 239   3            data_len++;
 240   3          }
C51 COMPILER V9.00   MAIN                                                                  02/26/2018 19:43:36 PAGE 5   

 241   2        }
 242   1      }
 243          
 244          void lcdjieshou(void) interrupt 8//½ÓÊÕ×Ö·û¼°´¦Àí
 245          { 
 246   1      
 247   1       uchar i,j;
 248   1       unsigned short crc_result,ck_crc;
 249   1      
 250   1      if(S2CON&S2RI)//ÓÐÊý¾Ý´«À´£¬Ó²¼þÖÃÎ»S2RI
 251   1      {
 252   2       S2CON&=~S2RI;  //Çå³ýÖÃÎ»£¬ÒÔ±ãÏÂÒ»Êý¾Ý´«À´             
 253   2         data_buf1[data_len1]=S2BUF; 
 254   2           if(start_recive1==0)
 255   2           {
 256   3             if(data_len1==0&&data_buf1[data_len1]==0xaa)
 257   3             {  
 258   4               data_len1=1;         
 259   4             }      
 260   3                 else if(data_len1==1&&data_buf1[data_len1]==0xaa)//ÈçÏÂ´Î´«À´µÄ»¹ÊÇÖ¡Í·ÔÙ´ÎÒÔaa¿ªÊ¼ÅÐ¶ÏÖ¡
 261   3             {  
 262   4              data_len1=1;  
 263   4             } 
 264   3             else if(data_len1==1&&data_buf1[data_len1]==0x55)
 265   3             {
 266   4               data_len1=2;           
 267   4             }    
 268   3             else if(data_len1==2&&data_buf1[data_len1]==0xcc)
 269   3             {  
 270   4              start_recive1=1;        
 271   4             }        
 272   3             else 
 273   3             {
 274   4              data_len1=0;
 275   4             }
 276   3           }    
 277   2           if(start_recive1==1)
 278   2           {
 279   3              
 280   3             if(start_fram1==1)//½ÓÊÕ³¤¶ÈÏÞÖÆ
 281   3             {
 282   4              if(frame_len1>=70)
 283   4              {
 284   5                 start_recive1=0;           
 285   5                 start_fram1=0;
 286   5                         data_len1=0;
 287   5                         frame_len1=0;
 288   5              }
 289   4              frame_len1--;
 290   4              if(frame_len1==0)
 291   4              {
 292   5                 crc_result = get_crc3(&data_buf1[3],data_buf1[5]+3);//Êý¾ÝÖ¡¼ÆËãCRC
 293   5                 ck_crc = data_buf1[ (data_buf1[5]+7)]<<8 | data_buf1[ (data_buf1[5]+6) ];//µÍ¸ß×Ö½ÚCRC×ª»»ÎªÕû”
             -¼
 294   5                     if(crc_result==ck_crc)//CRCÐ£Ñé±È¶Ô
 295   5                     {  
 296   6                       for(i=0;i<(data_buf1[5]/2);i++)//¼ÆËãÊý¾Ý¶Ô¸ö”¼
 297   6                       {
 298   7                         real_data1[i]=data_buf1[6+j]<<8| data_buf1[7+j];//ÓÐÐ§Êý¾ÝºÏÎª2¸ö×Ö½ÚµÄÊý¾Ý£¨Ò»¸ö¼Ä´æÆ÷µÄÊý¾ÝÖ
             -µÎª2¸ö×Ö½Ú£© 
 299   7                         j=j+2;
 300   7                       }               
C51 COMPILER V9.00   MAIN                                                                  02/26/2018 19:43:36 PAGE 6   

 301   6                 }            
 302   5                 start_recive1=0;
 303   5                 start_fram1=0;
 304   5                         data_len1=0;
 305   5                         frame_len1=0;
 306   5                         j=0; i=0;
 307   5      
 308   5                 if(real_data1[0]==0x0000)
 309   5                 {
 310   6                   //printf("Control_window\n");
 311   6                   lcd_status=Control_window;
 312   6                 }
 313   5                 if(real_data1[0]==0x0001)
 314   5                 {
 315   6                   //printf("Sensor_window\n");
 316   6                   lcd_status=Sensor_window;
 317   6                 }
 318   5                 if(real_data1[0]==0x0002)
 319   5                 {
 320   6                   //printf("Headctr_window\n");
 321   6                   lcd_status=Headctr_window;
 322   6                 }
 323   5                 if(real_data1[0]==0x0003)
 324   5                 {
 325   6                   //printf("versions_window\n");
 326   6                   lcd_status=versions_window;
 327   6                 } 
 328   5                 if(real_data1[0]==0x00bc)
 329   5                 {
 330   6                   //printf("back button\n");
 331   6                   lcd_status=Return_button;
 332   6                 }          
 333   5      
 334   5              }
 335   4            }        
 336   3            if(data_len1==5)
 337   3            {
 338   4              start_fram1=1;
 339   4              frame_len1=data_buf1[5]+2;
 340   4            }
 341   3            data_len1++;
 342   3          }
 343   2         
 344   2       }
 345   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1579    ----
   CONSTANT SIZE    =     50    ----
   XDATA SIZE       =    237      28
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
