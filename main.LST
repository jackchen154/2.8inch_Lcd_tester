C51 COMPILER V9.00   MAIN                                                                  03/09/2018 15:31:09 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include "STC12C5A.h"
   2          #include "main.h"
   3          #include "lcd_window.h"
   4          #include "uart.h"
   5          #include <intrins.h>  
   6          #define uchar unsigned char  
   7          #define uint  unsigned int 
   8          #define S2RI 0X01
   9          #define S2TI 0X02
  10          
  11          uchar lcd_status=0;//LCD½çÃæÇÐ»»×´Ì¬
  12          
  13          uchar com2_data[5]={0};
  14          uchar b=0;
  15          uchar data_buf[100]={0},start_recive=0,start_fram=0,frame_len=0,data_len=0;
  16          uchar data_buf1[20]={0},start_recive1=0,start_fram1=0,frame_len1=0,data_len1=0;
  17          
  18          unsigned short real_data[50]={0};
  19          unsigned short real_data1[1]={0};
  20          
  21          void Delay1ms()   //@11.0592MHz
  22          {
  23   1        unsigned char i, j;
  24   1      
  25   1        _nop_();
  26   1        _nop_();
  27   1        _nop_();
  28   1        i = 11;
  29   1        j = 190;
  30   1        do
  31   1        {
  32   2          while (--j);
  33   2        } while (--i);
  34   1      }
  35          
  36          void delayms(unsigned int ms)
  37          {
  38   1        while(ms--)
  39   1        Delay1ms();
  40   1      }
  41          
  42          
  43          
  44          void reboot(void)
  45          {
  46   1        IAP_CONTR=0X60;//×Ô¶¯ÖØÆôÏµÍ³
  47   1      }
  48          
  49          unsigned short get_crc1(uchar *ptr,uchar len)
  50          {
  51   1        uchar i;
  52   1        unsigned short crc=0xFFFF;
  53   1        if(len==0) len=1;
  54   1        while(len--)
  55   1        {
C51 COMPILER V9.00   MAIN                                                                  03/09/2018 15:31:09 PAGE 2   

  56   2          crc ^=*ptr;
  57   2          for(i=0;i<8;i++)
  58   2          {
  59   3            if(crc&1)
  60   3            {
  61   4              crc>>=1;
  62   4              crc ^= 0XA001; 
  63   4            }
  64   3            else crc>>=1;
  65   3          }
  66   2          ptr++;
  67   2        }
  68   1        return(crc);
  69   1      }
  70          
  71          unsigned short get_crc(uchar *ptr,uchar len)
  72          {
  73   1        uchar i;
  74   1        unsigned short crc=0xFFFF;
  75   1        if(len==0) len=1;
  76   1        while(len--)
  77   1        {
  78   2          crc ^=*ptr;
  79   2          for(i=0;i<8;i++)
  80   2          {
  81   3            if(crc&1)
  82   3            {
  83   4              crc>>=1;
  84   4              crc ^= 0XA001; 
  85   4            }
  86   3            else crc>>=1;
  87   3          }
  88   2          ptr++;
  89   2        }
  90   1        return(crc);
  91   1      }  
  92          
  93          unsigned short get_crc2(uchar *ptr,uchar len)
  94          {
  95   1        uchar i;
  96   1        unsigned short crc=0xFFFF;
  97   1        if(len==0) len=1;
  98   1        while(len--)
  99   1        {
 100   2          crc ^=*ptr;
 101   2          for(i=0;i<8;i++)
 102   2          {
 103   3            if(crc&1)
 104   3            {
 105   4              crc>>=1;
 106   4              crc ^= 0XA001; 
 107   4            }
 108   3            else crc>>=1;
 109   3          }
 110   2          ptr++;
 111   2        }
 112   1        return(crc);
 113   1      }
 114          
 115          unsigned short get_crc3(uchar *ptr,uchar len)
 116          {
 117   1        uchar i;
C51 COMPILER V9.00   MAIN                                                                  03/09/2018 15:31:09 PAGE 3   

 118   1        unsigned short crc=0xFFFF;
 119   1        if(len==0) len=1;
 120   1        while(len--)
 121   1        {
 122   2          crc ^=*ptr;
 123   2          for(i=0;i<8;i++)
 124   2          {
 125   3            if(crc&1)
 126   3            {
 127   4              crc>>=1;
 128   4              crc ^= 0XA001; 
 129   4            }
 130   3            else crc>>=1;
 131   3          }
 132   2          ptr++;
 133   2        }
 134   1        return(crc);
 135   1      } 
 136          
 137          void send_data(uchar device_n,uchar reg_n,uchar reg_mun)
 138          {
 139   1          unsigned short crc;
 140   1          uchar i=0;
 141   1          uchar read_buf[11]={0xaa,0x55,0xcc};
 142   1          read_buf[3]=device_n;
 143   1          read_buf[4]=0x03;
 144   1          read_buf[5]=0x00;
 145   1          read_buf[6]=reg_n;
 146   1          read_buf[7]=0x00;
 147   1          read_buf[8]=reg_mun;
 148   1          crc=get_crc1(&read_buf[3],6);
 149   1          read_buf[9]=crc&0xff;
 150   1          read_buf[10]=(crc>>8)&0xff;
 151   1          UART1_Send(read_buf,11);
 152   1        
 153   1      }      
 154          
 155          //(fd0,05,05,20,180)
 156          void motor_contrl_send(uchar device_n,uchar ctrl_mode,uchar speed,unsigned int weizhi)//¶æ»ú¿ØÖÆ
 157          {
 158   1            unsigned int crc;
 159   1            uchar read_buf[30]={0xaa,0x55,0xcc};
 160   1          read_buf[3]=device_n;
 161   1          read_buf[4]=0x10;
 162   1      
 163   1          read_buf[5]=0x00;
 164   1          read_buf[6]=0x00;
 165   1      
 166   1          read_buf[7]=0x00;
 167   1          read_buf[8]=0x07;
 168   1      
 169   1            read_buf[9]=0x0e;
 170   1      
 171   1            read_buf[10]=0x00;
 172   1            read_buf[11]=ctrl_mode;
 173   1      
 174   1            read_buf[12]=0x00;
 175   1            read_buf[13]=speed;
 176   1      
 177   1            read_buf[14]=weizhi>>8;
 178   1            read_buf[15]=weizhi&0x00ff;
 179   1      
C51 COMPILER V9.00   MAIN                                                                  03/09/2018 15:31:09 PAGE 4   

 180   1            read_buf[16]=0x12;
 181   1            read_buf[17]=0x0c;
 182   1      
 183   1            read_buf[18]=0x00;
 184   1            read_buf[19]=0x46;
 185   1      
 186   1            read_buf[20]=0x00;
 187   1            read_buf[21]=0x07;
 188   1      
 189   1            read_buf[22]=0x00;
 190   1            read_buf[23]=0x00;
 191   1      
 192   1          crc=get_crc2(&read_buf[3],21);
 193   1          read_buf[24]=crc&0xff;
 194   1          read_buf[25]=(crc>>8)&0xff;
 195   1      
 196   1          UART1_Send(read_buf,26);
 197   1      
 198   1        
 199   1      }
 200          
 201          void led_contrl_send(uchar device_n,uchar led1_cycle,uchar led2_cycle,uchar liangdu)//LED¿ØÖÆ
 202          {
 203   1            unsigned int crc;
 204   1            uchar read_buf[17]={0xaa,0x55,0xcc};
 205   1          read_buf[3]=device_n;
 206   1          read_buf[4]=0x10;
 207   1      
 208   1          read_buf[5]=0x00;
 209   1          read_buf[6]=0x00;
 210   1      
 211   1          read_buf[7]=0x00;
 212   1          read_buf[8]=0x03;
 213   1      
 214   1            read_buf[9]=0x06;
 215   1      
 216   1            read_buf[10]=0x00;
 217   1            read_buf[11]=led1_cycle;
 218   1      
 219   1            read_buf[12]=0x00;
 220   1            read_buf[13]=led2_cycle;
 221   1      
 222   1            read_buf[14]=0x00;
 223   1            read_buf[15]=liangdu;
 224   1      
 225   1          crc=get_crc2(&read_buf[3],13);
 226   1          read_buf[16]=crc&0xff;
 227   1          read_buf[17]=(crc>>8)&0xff;
 228   1          UART1_Send(read_buf,18);
 229   1        
 230   1      }
 231          
 232          
 233          void Main(void)  
 234          {  
 235   1        UART1_Init();
 236   1        UART2_Init();
 237   1      
 238   1        Lcd_control("page main");     
 239   1        while(1)
 240   1        { 
 241   2                if(lcd_status==Sensor_window)
C51 COMPILER V9.00   MAIN                                                                  03/09/2018 15:31:09 PAGE 5   

 242   2                {   
 243   3                    TH1 = 0xFD;   
 244   3                    TL1 = TH1;  //115200
 245   3                  
 246   3                    Lcd_control("page ultrasonic");     
 247   3                    while (1) 
 248   3                    { 
 249   4                      if(ultrasonic_window(real_data)<0) break;
 250   4                      delayms(1000);
 251   4                    }
 252   3                 }
 253   2      
 254   2                 if(lcd_status==versions_window)
 255   2                 {   
 256   3      
 257   3                    Lcd_control("page version");     
 258   3                    while (1) 
 259   3                    { 
 260   4                      if(version_window(real_data)<0) break;
 261   4                      delayms(1000);
 262   4                    }
 263   3                 }
 264   2                 
 265   2                 if(lcd_status==Headctr_window)
 266   2                 {   
 267   3                    TH1 = 0xf7; 
 268   3                    TL1 = TH1;  //38400²¨ÌØÂÊ  
 269   3                    Lcd_control("page head contrl"); 
 270   3                    motor_contrl_send(0x01,0x00,0,0);//³õÊ¼»¯¶æ»ú
 271   3                    delayms(5);
 272   3                    motor_contrl_send(0x06,0x00,0,0);//³õÊ¼»¯¶æ»ú
 273   3                    delayms(5);  
 274   3                    motor_contrl_send(0x07,0x00,0,0);//³õÊ¼»¯¶æ»ú     
 275   3                    while (1) //Ñ­»·¶ÁÈ¡Êý¾Ý
 276   3                    {         
 277   4                      if(motor_ctrl_window(real_data)<0) break;
 278   4                      delayms(5);
 279   4                    }
 280   3                 }           
 281   2              delayms(100);
 282   2              
 283   2         }//end while(1)
 284   1      }
 285            
 286          void zhukongjieshou(void) interrupt 4  
 287          {
 288   1        uchar i,j;
 289   1        unsigned short crc_result,ck_crc;            
 290   1        if(RI == 1)   //µ±Ó²¼þ½ÓÊÕµ½Ò»¸öÊý¾ÝÊ±£¬RI»áÖÃÎ»  
 291   1        {
 292   2          RI = 0; 
 293   2          data_buf[data_len]=SBUF;
 294   2          if(start_recive==0)
 295   2          {
 296   3            if(data_len==0&&data_buf[data_len]==0xaa)
 297   3            {  
 298   4              data_len=1; 
 299   4            }      
 300   3          else if(data_len==1&&data_buf[data_len]==0xaa)//ÈçÏÂ´Î´«À´µÄ»¹ÊÇÖ¡Í·ÔÙ´ÎÒÔaa¿ªÊ¼ÅÐ¶ÏÖ¡
 301   3            {  
 302   4             data_len=1;  
 303   4            } 
C51 COMPILER V9.00   MAIN                                                                  03/09/2018 15:31:09 PAGE 6   

 304   3            else if(data_len==1&&data_buf[data_len]==0x55)
 305   3            {
 306   4              data_len=2;  
 307   4            }    
 308   3            else if(data_len==2&&data_buf[data_len]==0xcc)
 309   3            {  
 310   4             start_recive=1;
 311   4            } 
 312   3            else 
 313   3            {
 314   4             data_len=0;
 315   4            }
 316   3          }    
 317   2          if(start_recive==1)
 318   2          {
 319   3            if(start_fram==1)//½ÓÊÕ³¤¶ÈÏÞÖÆ
 320   3            {
 321   4              if(frame_len>=70)
 322   4              {
 323   5                 start_recive=0;           
 324   5                 start_fram=0;
 325   5             data_len=0;
 326   5             frame_len=0;
 327   5                 return;
 328   5              }
 329   4              frame_len--;
 330   4              if(frame_len==0)
 331   4              {
 332   5                 crc_result = get_crc(&data_buf[3],data_buf[5]+3);//Êý¾ÝÖ¡¼ÆËãCRC
 333   5                 ck_crc = data_buf[ (data_buf[5]+7)]<<8 | data_buf[ (data_buf[5]+6) ];//µÍ¸ß×Ö½ÚCRC×ª»»ÎªÕûÊý
 334   5               if(crc_result==ck_crc)//CRCÐ£Ñé±È¶Ô
 335   5               {  
 336   6                 for(i=0;i<(data_buf[5]/2);i++)//¼ÆËãÊý¾Ý¶Ô¸öÊý
 337   6                 {
 338   7                   real_data[i]=data_buf[6+j]<<8| data_buf[7+j];//ÓÐÐ§Êý¾ÝºÏÎª2¸ö×Ö½ÚµÄÊý¾Ý£¨Ò»¸ö¼Ä´æÆ÷µÄÊý¾ÝÖµÎª
             -2¸ö×Ö½Ú£© 
 339   7                   j=j+2;
 340   7                 }           
 341   6               }
 342   5               if(real_data[0]==0x1122 && real_data[1]==0x3344)
 343   5               reboot();
 344   5               start_recive=0;
 345   5               start_fram=0;
 346   5               data_len=0;
 347   5               frame_len=0;
 348   5               j=0; i=0;
 349   5               return;
 350   5              }
 351   4            }        
 352   3            if(data_len==5)
 353   3            {
 354   4              start_fram=1;
 355   4              frame_len=data_buf[5]+2;
 356   4            }
 357   3            data_len++;
 358   3          }
 359   2        }
 360   1      }
 361          
 362          void lcdjieshou(void) interrupt 8//½ÓÊÕ×Ö·û¼°´¦Àí
 363          { 
 364   1      
C51 COMPILER V9.00   MAIN                                                                  03/09/2018 15:31:09 PAGE 7   

 365   1       uchar i,j;
 366   1       unsigned short crc_result,ck_crc;
 367   1      
 368   1      if(S2CON&S2RI)//ÓÐÊý¾Ý´«À´£¬Ó²¼þÖÃÎ»S2RI
 369   1      {
 370   2       S2CON&=~S2RI;  //Çå³ýÖÃÎ»£¬ÒÔ±ãÏÂÒ»Êý¾Ý´«À´     
 371   2         data_buf1[data_len1]=S2BUF; 
 372   2           if(start_recive1==0)
 373   2           {
 374   3             if(data_len1==0&&data_buf1[data_len1]==0xaa)
 375   3             {  
 376   4               data_len1=1;         
 377   4             }      
 378   3           else if(data_len1==1&&data_buf1[data_len1]==0xaa)//ÈçÏÂ´Î´«À´µÄ»¹ÊÇÖ¡Í·ÔÙ´ÎÒÔaa¿ªÊ¼ÅÐ¶ÏÖ¡
 379   3             {  
 380   4              data_len1=1;  
 381   4             } 
 382   3             else if(data_len1==1&&data_buf1[data_len1]==0x55)
 383   3             {
 384   4               data_len1=2;           
 385   4             }    
 386   3             else if(data_len1==2&&data_buf1[data_len1]==0xcc)
 387   3             {  
 388   4              start_recive1=1;        
 389   4             }  
 390   3             else 
 391   3             {
 392   4              data_len1=0;
 393   4             }
 394   3           }    
 395   2           if(start_recive1==1)
 396   2           {
 397   3              
 398   3             if(start_fram1==1)//½ÓÊÕ³¤¶ÈÏÞÖÆ
 399   3             {
 400   4              if(frame_len1>=70)
 401   4              {
 402   5                 start_recive1=0;           
 403   5                 start_fram1=0;
 404   5             data_len1=0;
 405   5             frame_len1=0;
 406   5              }
 407   4              frame_len1--;
 408   4              if(frame_len1==0)
 409   4              {
 410   5                 crc_result = get_crc3(&data_buf1[3],data_buf1[5]+3);//Êý¾ÝÖ¡¼ÆËãCRC
 411   5                 ck_crc = data_buf1[ (data_buf1[5]+7)]<<8 | data_buf1[ (data_buf1[5]+6) ];//µÍ¸ß×Ö½ÚCRC×ª»»ÎªÕû”
             -¼
 412   5               if(crc_result==ck_crc)//CRCÐ£Ñé±È¶Ô
 413   5               {  
 414   6                 for(i=0;i<(data_buf1[5]/2);i++)//¼ÆËãÊý¾Ý¶Ô¸ö”¼
 415   6                 {
 416   7                   real_data1[i]=data_buf1[6+j]<<8| data_buf1[7+j];//ÓÐÐ§Êý¾ÝºÏÎª2¸ö×Ö½ÚµÄÊý¾Ý£¨Ò»¸ö¼Ä´æÆ÷µÄÊý¾ÝÖ
             -µÎª2¸ö×Ö½Ú£© 
 417   7                   j=j+2;
 418   7                 }           
 419   6                 }            
 420   5                 start_recive1=0;
 421   5                 start_fram1=0;
 422   5             data_len1=0;
 423   5             frame_len1=0;
 424   5             j=0; i=0;
C51 COMPILER V9.00   MAIN                                                                  03/09/2018 15:31:09 PAGE 8   

 425   5           
 426   5                 //Ò³Ãæ´°¿Ú²¿¼þ
 427   5                 if(real_data1[0]==0x0000)
 428   5                 {
 429   6                   ////printf("Control_window\n");
 430   6                   lcd_status=Control_window;
 431   6                 }
 432   5                 if(real_data1[0]==0x0001)
 433   5                 {
 434   6                   ////printf("Sensor_window\n");
 435   6                   lcd_status=Sensor_window;
 436   6                 }
 437   5                 if(real_data1[0]==0x0002)
 438   5                 {
 439   6                   ////printf("Headctr_window\n");
 440   6                   lcd_status=Headctr_window;
 441   6                 }
 442   5                 if(real_data1[0]==0x0003)
 443   5                 {
 444   6                   ////printf("versions_window\n");
 445   6                   lcd_status=versions_window;
 446   6                 } 
 447   5                 if(real_data1[0]==0x00bc)
 448   5                 {
 449   6                   ////printf("back button\n");
 450   6                   lcd_status=Return_button;
 451   6                 }
 452   5                 //Í·²¿´°¿Ú²¿¼þ
 453   5                 if(real_data1[0]==0x0300)
 454   5                 {
 455   6                   ////printf("hbiaoding\n");
 456   6                   lcd_status=hbiaoding;
 457   6                 }
 458   5                 if(real_data1[0]==0x0301)
 459   5                 {
 460   6                   ////printf("hzuo\n");
 461   6                   lcd_status=hzuo;
 462   6                 } 
 463   5                 if(real_data1[0]==0x0302)
 464   5                 {
 465   6                   ////printf("hzhong\n");
 466   6                   lcd_status=hzhong;
 467   6                 } 
 468   5                 if(real_data1[0]==0x0303)
 469   5                 {
 470   6                   ////printf("hyou\n");
 471   6                   lcd_status=hyou;
 472   6                 }
 473   5      
 474   5                 //×óÊÖ´°¿Ú²¿¼þ
 475   5                 if(real_data1[0]==0x031a)
 476   5                 {
 477   6                   ////printf("jieshouzbiaoding\n");
 478   6                   lcd_status=zbiaoding;
 479   6                 }
 480   5                 if(real_data1[0]==0x0310)
 481   5                 {
 482   6                   ////printf("jieshouzzuo\n");
 483   6                   lcd_status=zzuo;
 484   6                 } 
 485   5                 if(real_data1[0]==0x0312)
 486   5                 {
C51 COMPILER V9.00   MAIN                                                                  03/09/2018 15:31:09 PAGE 9   

 487   6                   ////printf("jieshouzzhong\n");
 488   6                   lcd_status=zzhong;
 489   6                 } 
 490   5                 if(real_data1[0]==0x031b)
 491   5                 {
 492   6                   ////printf("jieshouzyou\n");
 493   6                   lcd_status=zyou;
 494   6                 }
 495   5      
 496   5                 //ÓÒÊÖ´°¿Ú²¿¼þ
 497   5                 if(real_data1[0]==0x0320)
 498   5                 {
 499   6                   ////printf("ybiaoding\n");
 500   6                   lcd_status=ybiaoding;
 501   6                 }
 502   5                 if(real_data1[0]==0x0321)
 503   5                 {
 504   6                   ////printf("yzuo\n");
 505   6                   lcd_status=yzuo;
 506   6                 } 
 507   5                 if(real_data1[0]==0x0322)
 508   5                 {
 509   6                   ////printf("yzhong\n");
 510   6                   lcd_status=yzhong;
 511   6                 } 
 512   5                 if(real_data1[0]==0x0323)
 513   5                 {
 514   6                   ////printf("yyou\n");
 515   6                   lcd_status=yyou;
 516   6                 }
 517   5      
 518   5                 //LEDµÆ°å¿ØÖÆ²¿¼þ 
 519   5                 if(real_data1[0]==0x03aa)
 520   5                 {
 521   6                   ////printf("zui0\n");
 522   6                   lcd_status=led00;
 523   6                 } 
 524   5                 if(real_data1[0]==0x03bb)
 525   5                 {
 526   6                   ////printf("zui1\n");
 527   6                   lcd_status=led01;
 528   6                 } 
 529   5                 if(real_data1[0]==0x03cc)
 530   5                 {
 531   6                   ////printf("yan0\n");
 532   6                   lcd_status=led10;
 533   6                 } 
 534   5                 if(real_data1[0]==0x03dd)
 535   5                 {
 536   6                   ////printf("yan1\n");
 537   6                   lcd_status=led11;
 538   6                 }
 539   5      
 540   5                 //Á¬Ðø¿ØÖÆ²¿¼þ 
 541   5                 if(real_data1[0]==0x0334)
 542   5                 {
 543   6                   ////printf("lianxu0\n");
 544   6                   lcd_status=alianxu0;
 545   6                 } 
 546   5                 if(real_data1[0]==0x0335)
 547   5                 {
 548   6                   ////printf("lianxu1\n");
C51 COMPILER V9.00   MAIN                                                                  03/09/2018 15:31:09 PAGE 10  

 549   6                   lcd_status=alianxu1;
 550   6                 }
 551   5                 real_data1[0]=0x0000;           
 552   5      
 553   5              }
 554   4            }        
 555   3            if(data_len1==5)
 556   3            {
 557   4              start_fram1=1;
 558   4              frame_len1=data_buf1[5]+2;
 559   4            }
 560   3            data_len1++;
 561   3          }
 562   2         
 563   2       }
 564   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2296    ----
   CONSTANT SIZE    =    114    ----
   XDATA SIZE       =    237      87
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
